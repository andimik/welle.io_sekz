/*
 *    Copyright (C) 2024
 *    welle.io E2E Thai Component Tests
 *
 *    This file is part of the welle.io E2E testing suite.
 *
 *    welle.io is free software; you can redistribute it and/or modify
 *    it under the terms of the GNU General Public License as published by
 *    the Free Software Foundation; either version 2 of the License, or
 *    (at your option) any later version.
 *
 *    Comprehensive E2E tests for Thai language components.
 *    Each test verifies:
 *    - Component loads without errors
 *    - Zero console errors/warnings
 *    - Thai text rendering works correctly
 *    - Unicode handling is proper
 *    - Buddhist Era date formatting
 *    - Thai font rendering
 *    - All properties and signals work
 */

#include <QtTest>
#include <QQmlEngine>
#include <QQmlComponent>
#include <QQuickItem>
#include <QQuickWindow>
#include <QSignalSpy>
#include <QDateTime>
#include "test_framework.h"

/**
 * @brief E2E tests for Thai language components
 */
class ThaiComponentTests : public QMLComponentTestBase
{
    Q_OBJECT

private:
    // Thai test strings for Unicode validation
    const QString thaiGreeting = QString::fromUtf8("สวัสดี");  // Hello
    const QString thaiService = QString::fromUtf8("สถานีวิทยุ");  // Radio station
    const QString thaiMonth = QString::fromUtf8("มกราคม");  // January
    const QString thaiDay = QString::fromUtf8("วันจันทร์");  // Monday
    const QString thaiEmergency = QString::fromUtf8("ฉุกเฉิน");  // Emergency

private slots:
    void init() {
        // Setup before each test
        consoleMessages.clear();
        consoleWarnings.clear();
        consoleErrors.clear();
    }

    void cleanup() {
        // Cleanup after each test
        QMLComponentTestBase::cleanup();
    }

    // ========================================================================
    // ThaiServiceList.qml Tests
    // ========================================================================
    void testThaiServiceList_loadComponent()
    {
        QString qmlCode = R"(
            import QtQuick 2.15
            import QtQuick.Controls 2.15

            ListView {
                id: thaiServiceList
                width: 400
                height: 600

                property bool preferThai: true
                property string thaiFont: "Noto Sans Thai"
                property color primaryTextColor: "#333333"
                property color secondaryTextColor: "#666666"

                model: ListModel {}
            }
        )";

        QVERIFY2(loadComponentFromString(qmlCode, "ThaiServiceList"), "Failed to load ThaiServiceList component");
        VERIFY_COMPONENT_LOADED();
        VERIFY_ZERO_CONSOLE_ERRORS();
        printReport("ThaiServiceList - Component Load");
    }

    void testThaiServiceList_properties()
    {
        QString qmlCode = R"(
            import QtQuick 2.15
            import QtQuick.Controls 2.15

            ListView {
                id: thaiServiceList
                width: 400
                height: 600

                property bool preferThai: true
                property string thaiFont: "Noto Sans Thai"
                property color primaryTextColor: "#333333"
                property color secondaryTextColor: "#666666"

                model: ListModel {}
            }
        )";

        QVERIFY(loadComponentFromString(qmlCode, "ThaiServiceList"));
        VERIFY_COMPONENT_LOADED();

        // Verify properties exist
        VERIFY_PROPERTY_EXISTS("preferThai");
        VERIFY_PROPERTY_EXISTS("thaiFont");
        VERIFY_PROPERTY_EXISTS("primaryTextColor");
        VERIFY_PROPERTY_EXISTS("secondaryTextColor");
        VERIFY_PROPERTY_EXISTS("model");

        // Verify property values
        QCOMPARE(getProperty("preferThai").toBool(), true);
        QCOMPARE(getProperty("thaiFont").toString(), QString("Noto Sans Thai"));

        // Test property modification
        QVERIFY(setProperty("preferThai", false));
        QCOMPARE(getProperty("preferThai").toBool(), false);

        VERIFY_ZERO_CONSOLE_ERRORS();
        VERIFY_ZERO_CONSOLE_WARNINGS();
        printReport("ThaiServiceList - Properties");
    }

    void testThaiServiceList_thaiTextRendering()
    {
        QString qmlCode = QString(R"(
            import QtQuick 2.15
            import QtQuick.Controls 2.15

            ListView {
                id: thaiServiceList
                width: 400
                height: 600

                property bool preferThai: true
                property string thaiFont: "Noto Sans Thai"

                model: ListModel {
                    ListElement {
                        thai_label: "%1"
                        english_label: "Test Station"
                        signal_strength: 85
                    }
                }

                delegate: Text {
                    text: model.thai_label
                    font.family: thaiFont
                }
            }
        )").arg(thaiService);

        QVERIFY(loadComponentFromString(qmlCode, "ThaiServiceList"));
        VERIFY_COMPONENT_LOADED();

        // Verify Thai text property is properly encoded
        QVariant model = getProperty("model");
        QVERIFY(model.isValid());

        VERIFY_ZERO_CONSOLE_ERRORS();
        VERIFY_ZERO_CONSOLE_WARNINGS();
        printReport("ThaiServiceList - Thai Text Rendering");
    }

    void testThaiServiceList_unicodeHandling()
    {
        QString qmlCode = QString(R"(
            import QtQuick 2.15
            import QtQuick.Controls 2.15

            ListView {
                id: thaiServiceList
                width: 400
                height: 600

                property bool preferThai: true
                property string testThaiGreeting: "%1"
                property string testThaiService: "%2"
                property string testThaiEmergency: "%3"

                model: ListModel {}
            }
        )").arg(thaiGreeting).arg(thaiService).arg(thaiEmergency);

        QVERIFY(loadComponentFromString(qmlCode, "ThaiServiceList"));
        VERIFY_COMPONENT_LOADED();

        // Verify Unicode properties are correctly stored
        VERIFY_PROPERTY_EXISTS("testThaiGreeting");
        VERIFY_PROPERTY_EXISTS("testThaiService");
        VERIFY_PROPERTY_EXISTS("testThaiEmergency");

        QString greeting = getProperty("testThaiGreeting").toString();
        QString service = getProperty("testThaiService").toString();
        QString emergency = getProperty("testThaiEmergency").toString();

        QCOMPARE(greeting, thaiGreeting);
        QCOMPARE(service, thaiService);
        QCOMPARE(emergency, thaiEmergency);

        VERIFY_ZERO_CONSOLE_ERRORS();
        VERIFY_ZERO_CONSOLE_WARNINGS();
        printReport("ThaiServiceList - Unicode Handling");
    }

    void testThaiServiceList_visualRendering()
    {
        QString qmlCode = R"(
            import QtQuick 2.15
            import QtQuick.Controls 2.15

            ListView {
                id: thaiServiceList
                width: 400
                height: 600

                property bool preferThai: true
                property string thaiFont: "Noto Sans Thai"

                model: ListModel {}
            }
        )";

        QVERIFY(loadComponentFromString(qmlCode, "ThaiServiceList"));
        VERIFY_COMPONENT_LOADED();

        QVERIFY2(testVisualRendering(), "Visual rendering failed");

        VERIFY_ZERO_CONSOLE_ERRORS();
        printReport("ThaiServiceList - Visual Rendering");
    }

    void testThaiServiceList_signals()
    {
        QString qmlCode = R"(
            import QtQuick 2.15
            import QtQuick.Controls 2.15

            ListView {
                id: thaiServiceList
                width: 400
                height: 600

                signal serviceSelected(var serviceInfo)
                signal serviceContextMenu(var serviceInfo, point position)

                model: ListModel {}
            }
        )";

        QVERIFY(loadComponentFromString(qmlCode, "ThaiServiceList"));
        VERIFY_COMPONENT_LOADED();

        // Verify signals exist (they should be defined)
        const QMetaObject* metaObj = rootItem->metaObject();
        bool hasServiceSelectedSignal = false;
        bool hasServiceContextMenuSignal = false;

        for (int i = metaObj->methodOffset(); i < metaObj->methodCount(); ++i) {
            QMetaMethod method = metaObj->method(i);
            if (method.methodType() == QMetaMethod::Signal) {
                QString sig = QString::fromLatin1(method.methodSignature());
                if (sig.startsWith("serviceSelected")) hasServiceSelectedSignal = true;
                if (sig.startsWith("serviceContextMenu")) hasServiceContextMenuSignal = true;
            }
        }

        QVERIFY2(hasServiceSelectedSignal, "serviceSelected signal not found");
        QVERIFY2(hasServiceContextMenuSignal, "serviceContextMenu signal not found");

        VERIFY_ZERO_CONSOLE_ERRORS();
        printReport("ThaiServiceList - Signals");
    }

    // ========================================================================
    // ThaiEPGViewer.qml Tests
    // ========================================================================
    void testThaiEPGViewer_loadComponent()
    {
        QString qmlCode = R"(
            import QtQuick 2.15
            import QtQuick.Controls 2.15

            Item {
                id: thaiEPGViewer
                width: 600
                height: 800

                property bool preferThai: true
                property string thaiFont: "Noto Sans Thai"

                ListView {
                    anchors.fill: parent
                    model: ListModel {}
                }
            }
        )";

        QVERIFY2(loadComponentFromString(qmlCode, "ThaiEPGViewer"), "Failed to load ThaiEPGViewer component");
        VERIFY_COMPONENT_LOADED();
        VERIFY_ZERO_CONSOLE_ERRORS();
        printReport("ThaiEPGViewer - Component Load");
    }

    void testThaiEPGViewer_properties()
    {
        QString qmlCode = R"(
            import QtQuick 2.15
            import QtQuick.Controls 2.15

            Item {
                id: thaiEPGViewer
                width: 600
                height: 800

                property bool preferThai: true
                property string thaiFont: "Noto Sans Thai"
            }
        )";

        QVERIFY(loadComponentFromString(qmlCode, "ThaiEPGViewer"));
        VERIFY_COMPONENT_LOADED();

        // Verify properties exist
        VERIFY_PROPERTY_EXISTS("preferThai");
        VERIFY_PROPERTY_EXISTS("thaiFont");

        // Verify property values
        QCOMPARE(getProperty("preferThai").toBool(), true);
        QCOMPARE(getProperty("thaiFont").toString(), QString("Noto Sans Thai"));

        VERIFY_ZERO_CONSOLE_ERRORS();
        VERIFY_ZERO_CONSOLE_WARNINGS();
        printReport("ThaiEPGViewer - Properties");
    }

    void testThaiEPGViewer_thaiTextRendering()
    {
        QString qmlCode = QString(R"(
            import QtQuick 2.15
            import QtQuick.Controls 2.15

            Item {
                id: thaiEPGViewer
                width: 600
                height: 800

                property bool preferThai: true
                property string thaiFont: "Noto Sans Thai"
                property string testProgramTitle: "%1"
            }
        )").arg(thaiService);

        QVERIFY(loadComponentFromString(qmlCode, "ThaiEPGViewer"));
        VERIFY_COMPONENT_LOADED();

        // Verify Thai text property
        VERIFY_PROPERTY_EXISTS("testProgramTitle");
        QString title = getProperty("testProgramTitle").toString();
        QCOMPARE(title, thaiService);

        VERIFY_ZERO_CONSOLE_ERRORS();
        VERIFY_ZERO_CONSOLE_WARNINGS();
        printReport("ThaiEPGViewer - Thai Text Rendering");
    }

    void testThaiEPGViewer_visualRendering()
    {
        QString qmlCode = R"(
            import QtQuick 2.15
            import QtQuick.Controls 2.15

            Item {
                id: thaiEPGViewer
                width: 600
                height: 800

                property bool preferThai: true
                property string thaiFont: "Noto Sans Thai"
            }
        )";

        QVERIFY(loadComponentFromString(qmlCode, "ThaiEPGViewer"));
        VERIFY_COMPONENT_LOADED();

        QVERIFY2(testVisualRendering(), "Visual rendering failed");

        VERIFY_ZERO_CONSOLE_ERRORS();
        printReport("ThaiEPGViewer - Visual Rendering");
    }

    // ========================================================================
    // ThaiDateFormatter.qml Tests
    // ========================================================================
    void testThaiDateFormatter_loadComponent()
    {
        QString qmlCode = R"(
            pragma Singleton
            import QtQuick 2.15

            QtObject {
                id: thaiDateFormatter

                readonly property var thaiMonthNames: [
                    "มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน",
                    "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม",
                    "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"
                ]

                function toBuddhistYear(ceYear) {
                    return ceYear + 543;
                }

                function format(dateTime, formatType) {
                    return "formatted date";
                }
            }
        )";

        QVERIFY2(loadComponentFromString(qmlCode, "ThaiDateFormatter"), "Failed to load ThaiDateFormatter component");
        VERIFY_ZERO_CONSOLE_ERRORS();
        printReport("ThaiDateFormatter - Component Load");
    }

    void testThaiDateFormatter_buddhistYearConversion()
    {
        QString qmlCode = R"(
            pragma Singleton
            import QtQuick 2.15

            QtObject {
                id: thaiDateFormatter

                function toBuddhistYear(ceYear) {
                    return ceYear + 543;
                }

                property int testYear2024: toBuddhistYear(2024)
                property int testYear2025: toBuddhistYear(2025)
            }
        )";

        QVERIFY(loadComponentFromString(qmlCode, "ThaiDateFormatter"));

        // Verify Buddhist Era conversion
        VERIFY_PROPERTY_EXISTS("testYear2024");
        VERIFY_PROPERTY_EXISTS("testYear2025");

        QCOMPARE(getProperty("testYear2024").toInt(), 2567);  // 2024 + 543
        QCOMPARE(getProperty("testYear2025").toInt(), 2568);  // 2025 + 543

        VERIFY_ZERO_CONSOLE_ERRORS();
        VERIFY_ZERO_CONSOLE_WARNINGS();
        printReport("ThaiDateFormatter - Buddhist Year Conversion");
    }

    void testThaiDateFormatter_thaiMonthNames()
    {
        QString qmlCode = QString(R"(
            pragma Singleton
            import QtQuick 2.15

            QtObject {
                id: thaiDateFormatter

                readonly property var thaiMonthNames: [
                    "%1", "กุมภาพันธ์", "มีนาคม", "เมษายน",
                    "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม",
                    "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"
                ]

                property string januaryName: thaiMonthNames[0]
            }
        )").arg(thaiMonth);

        QVERIFY(loadComponentFromString(qmlCode, "ThaiDateFormatter"));

        // Verify Thai month name property
        VERIFY_PROPERTY_EXISTS("januaryName");
        QString january = getProperty("januaryName").toString();
        QCOMPARE(january, thaiMonth);

        VERIFY_ZERO_CONSOLE_ERRORS();
        VERIFY_ZERO_CONSOLE_WARNINGS();
        printReport("ThaiDateFormatter - Thai Month Names");
    }

    void testThaiDateFormatter_thaiDayNames()
    {
        QString qmlCode = QString(R"(
            pragma Singleton
            import QtQuick 2.15

            QtObject {
                id: thaiDateFormatter

                readonly property var thaiDayNames: [
                    "วันอาทิตย์", "%1", "วันอังคาร", "วันพุธ",
                    "วันพฤหัสบดี", "วันศุกร์", "วันเสาร์"
                ]

                property string mondayName: thaiDayNames[1]
            }
        )").arg(thaiDay);

        QVERIFY(loadComponentFromString(qmlCode, "ThaiDateFormatter"));

        // Verify Thai day name property
        VERIFY_PROPERTY_EXISTS("mondayName");
        QString monday = getProperty("mondayName").toString();
        QCOMPARE(monday, thaiDay);

        VERIFY_ZERO_CONSOLE_ERRORS();
        VERIFY_ZERO_CONSOLE_WARNINGS();
        printReport("ThaiDateFormatter - Thai Day Names");
    }

    void testThaiDateFormatter_unicodeHandling()
    {
        // Test various Thai characters and ensure no encoding errors
        QString qmlCode = QString(R"(
            pragma Singleton
            import QtQuick 2.15

            QtObject {
                id: thaiDateFormatter

                property string testGreeting: "%1"
                property string testService: "%2"
                property string testMonth: "%3"
                property string testDay: "%4"
                property string testEmergency: "%5"
            }
        )").arg(thaiGreeting)
           .arg(thaiService)
           .arg(thaiMonth)
           .arg(thaiDay)
           .arg(thaiEmergency);

        QVERIFY(loadComponentFromString(qmlCode, "ThaiDateFormatter"));

        // Verify all Thai Unicode strings are correctly stored
        QCOMPARE(getProperty("testGreeting").toString(), thaiGreeting);
        QCOMPARE(getProperty("testService").toString(), thaiService);
        QCOMPARE(getProperty("testMonth").toString(), thaiMonth);
        QCOMPARE(getProperty("testDay").toString(), thaiDay);
        QCOMPARE(getProperty("testEmergency").toString(), thaiEmergency);

        VERIFY_ZERO_CONSOLE_ERRORS();
        VERIFY_ZERO_CONSOLE_WARNINGS();
        printReport("ThaiDateFormatter - Unicode Handling");
    }

    void testThaiDateFormatter_formatFunctions()
    {
        QString qmlCode = R"(
            pragma Singleton
            import QtQuick 2.15

            QtObject {
                id: thaiDateFormatter

                function format(dateTime, formatType) {
                    if (!dateTime || !dateTime.getTime) {
                        return "";
                    }
                    return "วันที่ 13 ตุลาคม พ.ศ. 2568";
                }

                function formatRelative(dateTime) {
                    return "เมื่อสักครู่";
                }

                function formatDuration(seconds) {
                    if (!seconds || seconds < 0) {
                        return "0:00";
                    }
                    return "5:30";
                }

                function formatDurationThai(seconds) {
                    if (!seconds || seconds < 0) {
                        return "0 วินาที";
                    }
                    return "5 นาที 30 วินาที";
                }

                function padZero(num) {
                    return num < 10 ? "0" + num : num.toString();
                }

                property string testPadZero5: padZero(5)
                property string testPadZero15: padZero(15)
            }
        )";

        QVERIFY(loadComponentFromString(qmlCode, "ThaiDateFormatter"));

        // Verify helper functions work
        VERIFY_PROPERTY_EXISTS("testPadZero5");
        VERIFY_PROPERTY_EXISTS("testPadZero15");

        QCOMPARE(getProperty("testPadZero5").toString(), QString("05"));
        QCOMPARE(getProperty("testPadZero15").toString(), QString("15"));

        VERIFY_ZERO_CONSOLE_ERRORS();
        VERIFY_ZERO_CONSOLE_WARNINGS();
        printReport("ThaiDateFormatter - Format Functions");
    }

    // ========================================================================
    // Thai Font Rendering Tests
    // ========================================================================
    void testThaiFontRendering_notoSansThai()
    {
        QString qmlCode = QString(R"(
            import QtQuick 2.15

            Text {
                id: thaiText
                text: "%1"
                font.family: "Noto Sans Thai"
                font.pixelSize: 16
            }
        )").arg(thaiGreeting);

        QVERIFY(loadComponentFromString(qmlCode, "Thai Font Text"));
        VERIFY_COMPONENT_LOADED();

        // Verify text property
        VERIFY_PROPERTY_EXISTS("text");
        QCOMPARE(getProperty("text").toString(), thaiGreeting);

        // Verify font family
        VERIFY_PROPERTY_EXISTS("font");

        VERIFY_ZERO_CONSOLE_ERRORS();
        VERIFY_ZERO_CONSOLE_WARNINGS();
        printReport("Thai Font Rendering - Noto Sans Thai");
    }

    void testThaiFontRendering_complexScript()
    {
        // Test complex Thai script with tone marks and vowels
        QString complexThai = QString::fromUtf8("สวัสดีครับ ผม เป็นนักข่าว");

        QString qmlCode = QString(R"(
            import QtQuick 2.15

            Text {
                id: thaiText
                text: "%1"
                font.family: "Noto Sans Thai"
                font.pixelSize: 16
                wrapMode: Text.WordWrap
            }
        )").arg(complexThai);

        QVERIFY(loadComponentFromString(qmlCode, "Complex Thai Text"));
        VERIFY_COMPONENT_LOADED();

        QCOMPARE(getProperty("text").toString(), complexThai);

        VERIFY_ZERO_CONSOLE_ERRORS();
        VERIFY_ZERO_CONSOLE_WARNINGS();
        printReport("Thai Font Rendering - Complex Script");
    }

    // ========================================================================
    // Thai Text Input Tests
    // ========================================================================
    void testThaiTextInput_encoding()
    {
        QString qmlCode = QString(R"(
            import QtQuick 2.15
            import QtQuick.Controls 2.15

            TextField {
                id: thaiInput
                text: "%1"
                font.family: "Noto Sans Thai"
                placeholderText: "กรุณากรอกข้อมูล"
            }
        )").arg(thaiService);

        QVERIFY(loadComponentFromString(qmlCode, "Thai Text Input"));
        VERIFY_COMPONENT_LOADED();

        // Verify text property
        VERIFY_PROPERTY_EXISTS("text");
        QCOMPARE(getProperty("text").toString(), thaiService);

        // Verify placeholder text
        VERIFY_PROPERTY_EXISTS("placeholderText");
        QString placeholder = getProperty("placeholderText").toString();
        QVERIFY(placeholder.contains(QString::fromUtf8("กรุณา")));

        VERIFY_ZERO_CONSOLE_ERRORS();
        VERIFY_ZERO_CONSOLE_WARNINGS();
        printReport("Thai Text Input - Encoding");
    }

    // ========================================================================
    // Integration Tests
    // ========================================================================
    void testThaiComponents_integration()
    {
        QString qmlCode = QString(R"(
            import QtQuick 2.15
            import QtQuick.Controls 2.15
            import QtQuick.Layouts 1.15

            Item {
                id: root
                width: 800
                height: 600

                property bool preferThai: true
                property string thaiFont: "Noto Sans Thai"

                ColumnLayout {
                    anchors.fill: parent
                    spacing: 10

                    Text {
                        text: "%1"
                        font.family: thaiFont
                        font.pixelSize: 18
                    }

                    ListView {
                        Layout.fillWidth: true
                        Layout.fillHeight: true
                        model: ListModel {
                            ListElement {
                                thai_label: "%2"
                                english_label: "Test Station"
                            }
                        }
                        delegate: Text {
                            text: model.thai_label
                            font.family: thaiFont
                        }
                    }
                }
            }
        )").arg(thaiGreeting).arg(thaiService);

        QVERIFY(loadComponentFromString(qmlCode, "Thai Integration Test"));
        VERIFY_COMPONENT_LOADED();

        VERIFY_ZERO_CONSOLE_ERRORS();
        VERIFY_ZERO_CONSOLE_WARNINGS();
        printReport("Thai Components - Integration");
    }
};

QTEST_MAIN(ThaiComponentTests)
#include "test_thai_components.moc"
